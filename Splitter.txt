import logging
from typing import List
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
# ... other imports

# 1. Create a custom logging filter to exclude specific endpoints
class EndpointFilter(logging.Filter):
    def __init__(self, endpoints_to_exclude: List[str], name=""):
        super().__init__(name)
        self.endpoints_to_exclude = endpoints_to_exclude

    def filter(self, record):
        try:
            # The request path is the third argument in the log record's message args
            request_path = record.args[2].split(" ")[1].split("?")[0]
            # Check if the exact path is in the list of endpoints to exclude
            return request_path not in self.endpoints_to_exclude
        except (IndexError, AttributeError):
            # Fallback for unexpected log formats
            return True

# Create FastAPI app instance
app = FastAPI()

# 2. Get the uvicorn.access logger and apply the filter
access_logger = logging.getLogger("uvicorn.access")

# Clear existing handlers to prevent log duplication, and add a custom one
access_logger.handlers.clear()
access_logger.propagate = False
access_handler = logging.StreamHandler()

# Define the precise list of endpoints you want to filter out
# The paths must match exactly what's in the browser's request
endpoints_to_filter = ["/user_checkin", "/active_users"]
access_handler.addFilter(EndpointFilter(endpoints_to_filter))

# Now, set the format for this handler, including the timestamp
formatter = logging.Formatter(
    fmt='%(levelprefix)s %(asctime)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
access_handler.setFormatter(formatter)
access_logger.addHandler(access_handler)

# 3. Add CORS middleware (your existing code)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
