import logging
import re
from fastapi import FastAPI

app = FastAPI()

# --- UUID regex ---
UUID_PATTERN = (
    r"[0-9a-fA-F]{8}-"
    r"[0-9a-fA-F]{4}-"
    r"[0-9a-fA-F]{4}-"
    r"[0-9a-fA-F]{4}-"
    r"[0-9a-fA-F]{12}"
)

class EndpointFilter(logging.Filter):
    def __init__(self, prefixes: list[str], extra_block: list[str] = None):
        super().__init__()
        self.blocked_patterns = []
        
        # Prefix rules â†’ match ANY method + prefix + UUID
        for prefix in prefixes:
            self.blocked_patterns.append(
                re.compile(fr'\"[A-Z]+ {prefix}{UUID_PATTERN}')
            )
        
        # Extra block rules (full regex applied directly)
        if extra_block:
            self.blocked_patterns += [re.compile(p) for p in extra_block]

    def filter(self, record: logging.LogRecord) -> bool:
        msg = record.getMessage()
        for pattern in self.blocked_patterns:
            if pattern.search(msg):
                return False  # block this log
        return True


# --- Apply to uvicorn.access logger ---
logging.getLogger("uvicorn.access").addFilter(
    EndpointFilter(
        prefixes=[
            r"/conversation/",   # matches /conversation/<UUID> (any method)
            r"/chat/",           # matches /chat/<UUID> (any method)
        ],
        extra_block=[
            r'GET /health',
            r'GET /favicon.ico'
        ]
    )
)


@app.get("/health")
async def health():
    return {"status": "ok"}


@app.get("/conversation/{conv_id}")
async def conversation(conv_id: str):
    return {"conversation": conv_id}


@app.post("/chat/{chat_id}")
async def chat(chat_id: str):
    return {"chat": chat_id}
