import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# Example data
df = pd.DataFrame({
    "Tc": ["A", "A", "B", "B"],
    "subtc": ["X", "Y", "Z", "W"],
    "word acc": [12, 43, 85, 74],
    "phrase acc": [12, 21, 9, 92],
    "character acc": [12, 54, 12, 12],
})

# Assign a shape for each subtc
subtc_shapes = {
    "X": "circle",
    "Y": "square",
    "Z": "triangle-up",
    "W": "diamond"
}

# Metrics and colors
metrics = ["word acc", "phrase acc", "character acc"]
colors = ["#1f77b4", "#ff7f0e", "#2ca02c"]

# Unique Tc
tcs = df["Tc"].unique()

# Subplots: 1 column, multiple rows
fig = make_subplots(
    rows=len(tcs), cols=1, shared_xaxes=True,
    subplot_titles=[f"Tc = {t}" for t in tcs]
)

# Add grouped bars
for i, tc in enumerate(tcs, start=1):
    subdf = df[df["Tc"] == tc]
    for metric, color in zip(metrics, colors):
        fig.add_trace(
            go.Bar(
                x=subdf["subtc"],
                y=subdf[metric],
                name=metric,
                marker_color=color,
                showlegend=(i == 1)
            ),
            row=i, col=1
        )

# Hide default x-tick labels (weâ€™ll replace them visually)
fig.update_xaxes(showticklabels=False)

# Add symbolic scatter markers as x-labels
symbol_y = -5  # slightly below x-axis
for subtc, symbol in subtc_shapes.items():
    fig.add_trace(go.Scatter(
        x=[subtc],
        y=[symbol_y],
        mode="markers",
        marker_symbol=symbol,
        marker_size=14,
        marker_color="black",
        name=f"{subtc} ({symbol})",  # legend label
        showlegend=True
    ))

# Only show shape legend once
for trace in fig.data:
    if isinstance(trace, go.Scatter):
        trace.showlegend = True
    else:
        trace.showlegend = False

# Final layout
fig.update_layout(
    barmode="group",
    title="Grouped Bar Chart with Symbolic X-Axis Labels",
    template="plotly_white",
    height=300 * len(tcs),
    width=900,
    legend_title="Legend",
    font=dict(size=13),
    margin=dict(l=60, r=20, t=60, b=80)
)

fig.show()
