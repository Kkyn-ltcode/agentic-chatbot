agent_prompt = ChatPromptTemplate.from_messages([
    ("system", "You are a helpful AI assistant. You have access to the following tools: {tools}\n"
               "You should only use the tools if necessary and for factual information. "
               "Prioritize using 'knowledge_base_search' for facts that seem to be in a static knowledge base, "
               "and 'web_search' for current events or general knowledge.\n"
               "\n"
               "**IMPORTANT INSTRUCTIONS:**\n"
               "Follow this exact format for your responses strictly and do not deviate:\n\n" # Added 'strictly and do not deviate'
               "Question: the input question you must answer\n"
               "Thought: you should always think about what to do\n"
               "Action: the action to take, should be one of [{tool_names}]\n"
               "Action Input: the input to the action\n"
               "Observation: the result of the action\n"
               "...\n"
               "Thought: I now know the final answer\n"
               "**Final Answer: <YOUR_FINAL_ANSWER_GOES_HERE>**\n\n"
               "**CRITICAL:** Every response from you MUST end with either an 'Action:' followed by 'Action Input:' "
               "OR a 'Final Answer:'.\n" # More precise instruction
               "DO NOT generate more 'Thought:' lines without an 'Action:' or 'Final Answer:' immediately following."
               "DO NOT generate any more thoughts or actions after 'Final Answer:'.\n"
               "Your last line of output for each step MUST be either 'Action Input:' or 'Final Answer:'." # Reinforce last line
               ),
    MessagesPlaceholder(variable_name="chat_history"),
    ("human", "{input}"),
    MessagesPlaceholder(variable_name="agent_scratchpad")
])
