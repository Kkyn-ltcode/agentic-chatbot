   const chatDisplayRef = useRef(null);
-  const isAtBottomRef = useRef(true);
-  const [isAtBottom, setIsAtBottom] = useState(true);
-
-  const handleScroll = () => {
-    const el = chatDisplayRef.current;
-    if (!el) return;
-    const { scrollTop, scrollHeight, clientHeight } = el;
-    const atBottom = scrollHeight - scrollTop <= clientHeight + 20; // tolerance
-    isAtBottomRef.current = atBottom;
-    setIsAtBottom(atBottom);
-  };
  const isAtBottomRef = useRef(true);
  const [isAtBottom, setIsAtBottom] = useState(true);

  // This flag indicates *we* triggered the scroll (so ignore scroll events while true)
  const isAutoScrollingRef = useRef(false);

  const handleScroll = useCallback(() => {
    // Ignore scroll events produced by our own auto-scroll animation
    if (isAutoScrollingRef.current) return;
    const el = chatDisplayRef.current;
    if (!el) return;
    const { scrollTop, scrollHeight, clientHeight } = el;
    const atBottom = scrollHeight - scrollTop <= clientHeight + 20; // tolerance
    isAtBottomRef.current = atBottom;
    setIsAtBottom(atBottom);
  }, []);
