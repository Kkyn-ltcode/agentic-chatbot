import dash
from dash import dcc, html, dash_table, Input, Output, State, callback_context
import dash_bootstrap_components as dbc
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd
import numpy as np
from pathlib import Path
import openpyxl
from datetime import datetime
import threading
import time

# Configuration
FOLDER_PATH = "./data"  # Change this to your folder path
REFRESH_INTERVAL = 30000  # 30 seconds in milliseconds

# Color scheme - Modern professional palette
COLORS = {
    'primary': '#2E86AB',
    'secondary': '#A23B72',
    'success': '#06A77D',
    'warning': '#F18F01',
    'danger': '#C73E1D',
    'background': '#F8F9FA',
    'card': '#FFFFFF',
    'text': '#2C3E50',
    'border': '#E9ECEF'
}

class DataLoader:
    def __init__(self, folder_path):
        self.folder_path = Path(folder_path)
        self.data_cache = {}
        self.last_update = None
        
    def load_all_data(self):
        """Load all xlsx file pairs from the folder"""
        summary_files = list(self.folder_path.glob("*_[0-9]*.xlsx"))
        summary_files = [f for f in summary_files if not f.stem.endswith('_cer')]
        
        all_summary = []
        all_details = []
        
        for summary_file in summary_files:
            # Load summary file
            try:
                df_summary = pd.read_excel(summary_file)
                df_summary['file_source'] = summary_file.stem
                all_summary.append(df_summary)
                
                # Load corresponding detail file
                detail_file = summary_file.parent / f"{summary_file.stem}_cer.xlsx"
                if detail_file.exists():
                    xl_file = pd.ExcelFile(detail_file)
                    for sheet_name in xl_file.sheet_names:
                        df_detail = pd.read_excel(detail_file, sheet_name=sheet_name)
                        df_detail['subtc'] = sheet_name
                        df_detail['file_source'] = summary_file.stem
                        all_details.append(df_detail)
            except Exception as e:
                print(f"Error loading {summary_file}: {e}")
        
        self.data_cache['summary'] = pd.concat(all_summary, ignore_index=True) if all_summary else pd.DataFrame()
        self.data_cache['details'] = pd.concat(all_details, ignore_index=True) if all_details else pd.DataFrame()
        self.last_update = datetime.now()
        
        return self.data_cache
    
    def get_data(self):
        if not self.data_cache:
            self.load_all_data()
        return self.data_cache

# Initialize app
app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])
loader = DataLoader(FOLDER_PATH)

# App layout
app.layout = dbc.Container([
    # Store for data
    dcc.Store(id='data-store'),
    dcc.Interval(id='interval-component', interval=REFRESH_INTERVAL, n_intervals=0),
    
    # Header
    dbc.Row([
        dbc.Col([
            html.H1("ASR Performance Monitoring Dashboard", 
                   className="text-center mb-2",
                   style={'color': COLORS['primary'], 'fontWeight': 'bold'}),
            html.P(id='last-update', className="text-center text-muted mb-4")
        ])
    ]),
    
    # Tabs
    dbc.Tabs([
        # Overview Tab
        dbc.Tab(label="Overview", tab_id="overview", children=[
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Total Utterances", className="text-muted"),
                            html.H2(id="total-utt", className="text-primary")
                        ])
                    ], className="mb-3 shadow-sm")
                ], width=3),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Avg Word Acc", className="text-muted"),
                            html.H2(id="avg-word-acc", className="text-success")
                        ])
                    ], className="mb-3 shadow-sm")
                ], width=3),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Avg Phrase Acc", className="text-muted"),
                            html.H2(id="avg-phrase-acc", className="text-info")
                        ])
                    ], className="mb-3 shadow-sm")
                ], width=3),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Avg Char Acc", className="text-muted"),
                            html.H2(id="avg-char-acc", className="text-warning")
                        ])
                    ], className="mb-3 shadow-sm")
                ], width=3),
            ], className="mb-4"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            dcc.Graph(id='accuracy-comparison')
                        ])
                    ], className="shadow-sm")
                ], width=6),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            dcc.Graph(id='tc-performance')
                        ])
                    ], className="shadow-sm")
                ], width=6),
            ], className="mb-4"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            dcc.Graph(id='heatmap-performance')
                        ])
                    ], className="shadow-sm")
                ], width=12),
            ])
        ]),
        
        # Category Analysis Tab
        dbc.Tab(label="Category Analysis", tab_id="category", children=[
            dbc.Row([
                dbc.Col([
                    html.Label("Select Tc:"),
                    dcc.Dropdown(id='tc-filter', multi=True, placeholder="All categories")
                ], width=4),
                dbc.Col([
                    html.Label("Select subtc:"),
                    dcc.Dropdown(id='subtc-filter', multi=True, placeholder="All sub-categories")
                ], width=4),
                dbc.Col([
                    html.Label("Select File:"),
                    dcc.Dropdown(id='file-filter', multi=True, placeholder="All files")
                ], width=4),
            ], className="mb-4 mt-3"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            dcc.Graph(id='subtc-breakdown')
                        ])
                    ], className="shadow-sm")
                ], width=12),
            ], className="mb-4"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Detailed Metrics Table"),
                            dash_table.DataTable(
                                id='summary-table',
                                style_table={'overflowX': 'auto'},
                                style_cell={'textAlign': 'left', 'padding': '10px'},
                                style_header={
                                    'backgroundColor': COLORS['primary'],
                                    'color': 'white',
                                    'fontWeight': 'bold'
                                },
                                style_data_conditional=[
                                    {
                                        'if': {'row_index': 'odd'},
                                        'backgroundColor': COLORS['background']
                                    }
                                ],
                                page_size=15,
                                sort_action='native',
                                filter_action='native'
                            )
                        ])
                    ], className="shadow-sm")
                ], width=12),
            ])
        ]),
        
        # Error Analysis Tab
        dbc.Tab(label="Error Analysis", tab_id="error", children=[
            dbc.Row([
                dbc.Col([
                    html.Label("Filter by subtc:"),
                    dcc.Dropdown(id='error-subtc-filter', placeholder="Select sub-category")
                ], width=6),
                dbc.Col([
                    html.Label("Filter by Result:"),
                    dcc.Dropdown(
                        id='result-filter',
                        options=[
                            {'label': 'All', 'value': 'ALL'},
                            {'label': 'PASS', 'value': 'PASS'},
                            {'label': 'FAIL', 'value': 'FAIL'}
                        ],
                        value='ALL'
                    )
                ], width=6),
            ], className="mb-4 mt-3"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            dcc.Graph(id='pass-fail-chart')
                        ])
                    ], className="shadow-sm")
                ], width=6),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            dcc.Graph(id='error-distribution')
                        ])
                    ], className="shadow-sm")
                ], width=6),
            ], className="mb-4"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Utterance Details"),
                            dash_table.DataTable(
                                id='error-table',
                                style_table={'overflowX': 'auto'},
                                style_cell={
                                    'textAlign': 'left',
                                    'padding': '10px',
                                    'whiteSpace': 'normal',
                                    'height': 'auto',
                                },
                                style_header={
                                    'backgroundColor': COLORS['primary'],
                                    'color': 'white',
                                    'fontWeight': 'bold'
                                },
                                style_data_conditional=[
                                    {
                                        'if': {'row_index': 'odd'},
                                        'backgroundColor': COLORS['background']
                                    },
                                    {
                                        'if': {
                                            'filter_query': '{result} = "FAIL"',
                                            'column_id': 'result'
                                        },
                                        'backgroundColor': '#FFE5E5',
                                        'color': COLORS['danger']
                                    },
                                    {
                                        'if': {
                                            'filter_query': '{result} = "PASS"',
                                            'column_id': 'result'
                                        },
                                        'backgroundColor': '#E5F9F0',
                                        'color': COLORS['success']
                                    }
                                ],
                                page_size=20,
                                sort_action='native',
                                filter_action='native'
                            )
                        ])
                    ], className="shadow-sm")
                ], width=12),
            ])
        ]),
        
        # Utterance Inspector Tab
        dbc.Tab(label="Utterance Inspector", tab_id="inspector", children=[
            dbc.Row([
                dbc.Col([
                    html.Label("Search in Reference/Hypothesis:"),
                    dcc.Input(
                        id='search-input',
                        type='text',
                        placeholder='Enter text to search...',
                        className='form-control mb-3'
                    )
                ], width=12),
            ], className="mt-3"),
            
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("Search Results"),
                            dash_table.DataTable(
                                id='search-table',
                                style_table={'overflowX': 'auto'},
                                style_cell={
                                    'textAlign': 'left',
                                    'padding': '10px',
                                    'whiteSpace': 'normal',
                                    'height': 'auto',
                                    'minWidth': '100px',
                                },
                                style_header={
                                    'backgroundColor': COLORS['primary'],
                                    'color': 'white',
                                    'fontWeight': 'bold'
                                },
                                style_data_conditional=[
                                    {
                                        'if': {'row_index': 'odd'},
                                        'backgroundColor': COLORS['background']
                                    }
                                ],
                                page_size=25,
                                sort_action='native'
                            )
                        ])
                    ], className="shadow-sm")
                ], width=12),
            ])
        ]),
    ], id="tabs", active_tab="overview")
], fluid=True, style={'backgroundColor': COLORS['background'], 'padding': '20px'})

# Callbacks
@app.callback(
    [Output('data-store', 'data'),
     Output('last-update', 'children')],
    [Input('interval-component', 'n_intervals')]
)
def update_data(n):
    data = loader.load_all_data()
    update_time = loader.last_update.strftime("%Y-%m-%d %H:%M:%S") if loader.last_update else "Never"
    return data, f"Last updated: {update_time}"

# Update filter options
@app.callback(
    [Output('tc-filter', 'options'),
     Output('subtc-filter', 'options'),
     Output('file-filter', 'options'),
     Output('error-subtc-filter', 'options')],
    [Input('data-store', 'data')]
)
def update_filters(data):
    if not data or data['summary'].empty:
        return [], [], [], []
    
    df = pd.DataFrame(data['summary'])
    tc_options = [{'label': tc, 'value': tc} for tc in sorted(df['Tc'].unique())]
    subtc_options = [{'label': subtc, 'value': subtc} for subtc in sorted(df['subtc'].unique())]
    file_options = [{'label': f, 'value': f} for f in sorted(df['file_source'].unique())]
    
    return tc_options, subtc_options, file_options, subtc_options

# Update KPIs
@app.callback(
    [Output('total-utt', 'children'),
     Output('avg-word-acc', 'children'),
     Output('avg-phrase-acc', 'children'),
     Output('avg-char-acc', 'children')],
    [Input('data-store', 'data')]
)
def update_kpis(data):
    if not data or data['summary'].empty:
        return "0", "0%", "0%", "0%"
    
    df = pd.DataFrame(data['summary'])
    
    # Normalize column names
    df.columns = df.columns.str.strip().str.lower()
    
    total_utt = f"{len(df):,}"
    avg_word = f"{df['word acc'].mean():.1f}%" if 'word acc' in df.columns else "N/A"
    avg_phrase = f"{df['phrase acc'].mean():.1f}%" if 'phrase acc' in df.columns else "N/A"
    avg_char = f"{df['character acc'].mean():.1f}%" if 'character acc' in df.columns else "N/A"
    
    return total_utt, avg_word, avg_phrase, avg_char

# Update charts
@app.callback(
    [Output('accuracy-comparison', 'figure'),
     Output('tc-performance', 'figure'),
     Output('heatmap-performance', 'figure')],
    [Input('data-store', 'data')]
)
def update_overview_charts(data):
    if not data or data['summary'].empty:
        empty_fig = go.Figure()
        empty_fig.add_annotation(text="No data available", showarrow=False)
        return empty_fig, empty_fig, empty_fig
    
    df = pd.DataFrame(data['summary'])
    df.columns = df.columns.str.strip().str.lower()
    
    # Accuracy comparison
    acc_cols = ['word acc', 'phrase acc', 'character acc']
    acc_cols = [col for col in acc_cols if col in df.columns]
    avg_accs = df[acc_cols].mean()
    
    fig1 = go.Figure(data=[
        go.Bar(x=avg_accs.index, y=avg_accs.values,
               marker_color=[COLORS['success'], COLORS['primary'], COLORS['warning']])
    ])
    fig1.update_layout(
        title="Average Accuracy Metrics",
        xaxis_title="Metric Type",
        yaxis_title="Accuracy (%)",
        template="plotly_white"
    )
    
    # Performance by Tc
    tc_col = 'tc' if 'tc' in df.columns else 'Tc' if 'Tc' in df.columns else None
    if tc_col:
        tc_perf = df.groupby(tc_col)[acc_cols].mean().reset_index()
        fig2 = go.Figure()
        for col in acc_cols:
            fig2.add_trace(go.Bar(name=col, x=tc_perf[tc_col], y=tc_perf[col]))
        fig2.update_layout(
            title="Performance by Category (Tc)",
            xaxis_title="Category",
            yaxis_title="Accuracy (%)",
            barmode='group',
            template="plotly_white"
        )
    else:
        fig2 = go.Figure()
        fig2.add_annotation(text="Tc column not found", showarrow=False)
    
    # Heatmap
    if tc_col and 'subtc' in df.columns:
        pivot_data = df.pivot_table(values='word acc', index=tc_col, columns='subtc', aggfunc='mean')
        fig3 = go.Figure(data=go.Heatmap(
            z=pivot_data.values,
            x=pivot_data.columns,
            y=pivot_data.index,
            colorscale='RdYlGn',
            text=pivot_data.values,
            texttemplate='%{text:.1f}',
            textfont={"size": 10}
        ))
        fig3.update_layout(
            title="Performance Heatmap (Tc vs subtc)",
            xaxis_title="Sub-category",
            yaxis_title="Category",
            template="plotly_white"
        )
    else:
        fig3 = go.Figure()
        fig3.add_annotation(text="Insufficient data for heatmap", showarrow=False)
    
    return fig1, fig2, fig3

# Category analysis callbacks
@app.callback(
    [Output('subtc-breakdown', 'figure'),
     Output('summary-table', 'data'),
     Output('summary-table', 'columns')],
    [Input('data-store', 'data'),
     Input('tc-filter', 'value'),
     Input('subtc-filter', 'value'),
     Input('file-filter', 'value')]
)
def update_category_analysis(data, tc_filter, subtc_filter, file_filter):
    if not data or data['summary'].empty:
        empty_fig = go.Figure()
        empty_fig.add_annotation(text="No data available", showarrow=False)
        return empty_fig, [], []
    
    df = pd.DataFrame(data['summary'])
    df.columns = df.columns.str.strip().str.lower()
    
    # Apply filters
    tc_col = 'tc' if 'tc' in df.columns else 'Tc' if 'Tc' in df.columns else None
    if tc_filter and tc_col:
        df = df[df[tc_col].isin(tc_filter)]
    if subtc_filter:
        df = df[df['subtc'].isin(subtc_filter)]
    if file_filter:
        df = df[df['file_source'].isin(file_filter)]
    
    # Subtc breakdown
    if 'subtc' in df.columns:
        subtc_perf = df.groupby('subtc')[['word acc', 'phrase acc', 'character acc']].mean().reset_index()
        fig = go.Figure()
        fig.add_trace(go.Bar(name='Word Acc', x=subtc_perf['subtc'], y=subtc_perf['word acc']))
        fig.add_trace(go.Bar(name='Phrase Acc', x=subtc_perf['subtc'], y=subtc_perf['phrase acc']))
        fig.add_trace(go.Bar(name='Char Acc', x=subtc_perf['subtc'], y=subtc_perf['character acc']))
        fig.update_layout(
            title="Performance by Sub-category",
            xaxis_title="Sub-category",
            yaxis_title="Accuracy (%)",
            barmode='group',
            template="plotly_white"
        )
    else:
        fig = go.Figure()
        fig.add_annotation(text="No subtc data available", showarrow=False)
    
    # Table data
    table_data = df.to_dict('records')
    columns = [{"name": col, "id": col} for col in df.columns]
    
    return fig, table_data, columns

# Error analysis callbacks
@app.callback(
    [Output('pass-fail-chart', 'figure'),
     Output('error-distribution', 'figure'),
     Output('error-table', 'data'),
     Output('error-table', 'columns')],
    [Input('data-store', 'data'),
     Input('error-subtc-filter', 'value'),
     Input('result-filter', 'value')]
)
def update_error_analysis(data, subtc_filter, result_filter):
    if not data or data['details'].empty:
        empty_fig = go.Figure()
        empty_fig.add_annotation(text="No data available", showarrow=False)
        return empty_fig, empty_fig, [], []
    
    df = pd.DataFrame(data['details'])
    df.columns = df.columns.str.strip()
    
    # Apply filters
    if subtc_filter:
        df = df[df['subtc'] == subtc_filter]
    if result_filter and result_filter != 'ALL':
        df = df[df['result'] == result_filter]
    
    # Pass/Fail chart
    if 'result' in df.columns:
        result_counts = df['result'].value_counts()
        fig1 = go.Figure(data=[go.Pie(
            labels=result_counts.index,
            values=result_counts.values,
            marker_colors=[COLORS['success'] if x == 'PASS' else COLORS['danger'] for x in result_counts.index]
        )])
        fig1.update_layout(title="Pass/Fail Distribution", template="plotly_white")
    else:
        fig1 = go.Figure()
        fig1.add_annotation(text="No result data available", showarrow=False)
    
    # Error distribution by subtc
    if 'subtc' in df.columns and 'result' in df.columns:
        error_dist = df.groupby(['subtc', 'result']).size().reset_index(name='count')
        fig2 = px.bar(error_dist, x='subtc', y='count', color='result',
                      color_discrete_map={'PASS': COLORS['success'], 'FAIL': COLORS['danger']},
                      title="Error Distribution by Sub-category")
        fig2.update_layout(template="plotly_white")
    else:
        fig2 = go.Figure()
        fig2.add_annotation(text="Insufficient data for distribution", showarrow=False)
    
    # Table data
    table_data = df.to_dict('records')
    columns = [{"name": col, "id": col} for col in df.columns]
    
    return fig1, fig2, table_data, columns

# Search functionality
@app.callback(
    [Output('search-table', 'data'),
     Output('search-table', 'columns')],
    [Input('search-input', 'value'),
     Input('data-store', 'data')]
)
def search_utterances(search_term, data):
    if not data or data['details'].empty or not search_term:
        return [], []
    
    df = pd.DataFrame(data['details'])
    df.columns = df.columns.str.strip()
    
    # Search in Reference and hypothesis columns
    mask = False
    for col in df.columns:
        if df[col].dtype == 'object':
            mask = mask | df[col].str.contains(search_term, case=False, na=False)
    
    filtered_df = df[mask]
    
    table_data = filtered_df.to_dict('records')
    columns = [{"name": col, "id": col} for col in filtered_df.columns]
    
    return table_data, columns

if __name__ == '__main__':
    app.run_server(debug=True, host='0.0.0.0', port=8050)
